name: Deploy

on:
  push:
    branches: [ chillout-chat/main ]
  pull_request:
    branches: [ chillout-chat/main ]

env:
  PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  USERNAME: ${{ secrets.SSH_USERNAME }}
  HOST: ${{ secrets.SSH_HOST }}
  PORT: ${{ secrets.SSH_PORT }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - run: |
          mkdir -p ~/.ssh/
          echo "$PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh -oStrictHostKeyChecking=no $USERNAME@$HOST -i ~/.ssh/id_rsa -p $PORT
          cd mastodon && git fetch origin && git pull origin chillout-chat/main
          docker-compose build
          docker-compose run --rm web rails db:migrate
          docker-compose run --rm web rails assets:precompile
          docker-compose up -d --remove-orphans
          docker system prune -f
